# JFinal CMS 5.1.0 命令执行漏洞分析(CVE-2024-53477)

## 环境搭建

```
git clone https://github.com/jflyfox/jfinal_cms.git
```

拉取5.1.0版本。

Tomcat 9.0.96
JDK 17.0.1

![image-20241229181056450](https://foreverwlwl.oss-cn-beijing.aliyuncs.com/typora/202412291810574.png)

## 漏洞简述

在这个版本，Maven中使用了Fastjson1.2.62版本，该版本存在反序列化漏洞。而正好这个版本存在一个可控的parseObject

## 漏洞分析

因为是Fastjson漏洞，全局搜索parseObject
![image-20241229181359145](https://foreverwlwl.oss-cn-beijing.aliyuncs.com/typora/202412291813200.png)

我们跟进到`com.jflyfox.api.form.ApiForm#getParams`

![image-20241229181440636](https://foreverwlwl.oss-cn-beijing.aliyuncs.com/typora/202412291814679.png)

这里对params使用了parseObject，而这个params是p而来的，看p
![image-20241229181602069](https://foreverwlwl.oss-cn-beijing.aliyuncs.com/typora/202412291816116.png)

p就是ApiForm的一个属性。现在找哪里用了`getParams`
![image-20241229181704540](https://foreverwlwl.oss-cn-beijing.aliyuncs.com/typora/202412291817569.png)

为这几个，继续往上找；发现这几个方法都会在`ApiV100Logic`或者`BaseApiLogic`中被调用,且`ApiV100Logic`继承`BaseApiLogic`

我们看`com.jflyfox.api.service.impl.ApiV100Logic#`里面很多方法都能够触发`com.jflyfox.api.form.ApiForm#`中的`get`方法,那么就能调用到`com.jflyfox.api.form.ApiForm#getParams`
现在去找怎么调用到`com.jflyfox.api.service.impl.ApiV100Logic#`中的方法。

去找controller，去看`com.jflyfox.api.controller.ApiController#action`的具体实现；

![image-20241229182611780](https://foreverwlwl.oss-cn-beijing.aliyuncs.com/typora/202412291826842.png)

这里很关键，这能返回一个IApiLogic类型的实例，通过反射调用接口；跟进到` ReflectionUtils.invokeMethod`
![image-20241229182915206](https://foreverwlwl.oss-cn-beijing.aliyuncs.com/typora/202412291829257.png)

这里通过反射调用方法；我们传入IApiLogic实例然后加一个方法就进入了`ApiV100Logic`；这里以`article`为例，

![image-20241229183121892](https://foreverwlwl.oss-cn-beijing.aliyuncs.com/typora/202412291831924.png)

这里调用了`ApiForm.getInt`
![image-20241229183236733](https://foreverwlwl.oss-cn-beijing.aliyuncs.com/typora/202412291832780.png)

形成闭环了。

## 调试过程

![image-20241229183510574](https://foreverwlwl.oss-cn-beijing.aliyuncs.com/typora/202412291835640.png)

![image-20241229183531407](https://foreverwlwl.oss-cn-beijing.aliyuncs.com/typora/202412291835477.png)

![image-20241229183606389](https://foreverwlwl.oss-cn-beijing.aliyuncs.com/typora/202412291836439.png)

![image-20241229183622471](https://foreverwlwl.oss-cn-beijing.aliyuncs.com/typora/202412291836535.png)

![image-20241229183642271](https://foreverwlwl.oss-cn-beijing.aliyuncs.com/typora/202412291836333.png)

重拾几个月前学的东西。。。